---
title: "Race/Ethnicity, County-Level Poverty, and Colon Cancer-Specific Survival in
  SEER, 2010-2020"
author: "Gagan Vijay"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
    number_sections: false
    theme: flatly
    highlight: tango
    df_print: paged
  pdf_document:
    toc: true
    toc_depth: '3'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  results = 'asis',
  fig.width = 12,
  fig.height = 8,
  dpi = 300
)

options(knitr.table.format = "html")
```

---

# METHODS

## Study Population and Data Source

Data were obtained from the Surveillance, Epidemiology, and End Results (SEER) Research Database for colon cancer patients (ICD-O-3 codes C18.0-C18.8) diagnosed 2010-2020. The study population consisted of patients with complete data on race/ethnicity, income category, age, sex, cancer stage, and survival status. Complete case analysis was used; patients with missing values on age (n=845) or income category (n=4) were excluded, resulting in an analytical sample of n=181,264.

## Variables and Operationalization

**Outcome Variable - Cancer-Specific Survival:**

- Measured as months from cancer diagnosis to cancer-specific death or censoring at last follow-up
- Death classification: "Dead (attributable to this cancer dx)" coded as event=1, all others coded as event=0
- Time variable derived from SEER survival_months field

**Primary Exposure 1 - Race/Ethnicity:**

- Original SEER variable: race_and_origin_recode_nhw_nhb_nhaian_nhapi_hispanic
- Recoded into 6 categories:
  - "Non-Hispanic White" - NHW (reference)
  - "Non-Hispanic Black" - NHB
  - "Hispanic (All Races)" - Hispanic
  - "Non-Hispanic Asian or Pacific Islander" - API
  - "Non-Hispanic American Indian/Alaska Native" - AIAN
  - All other categories - Other
- Stored as ordered factor with NHW as reference level

**Primary Exposure 2 - County-Level Income:**

- Original SEER variable: median_household_income_inflation_adj_to_2021
- Recoded into 5 ordered categories based on income thresholds:
  - "< $35,000", "$35,000 - $39,999", "$40,000 - $44,999" - Low income (reference)
  - "$45,000 - $49,999", "$50,000 - $54,999" - Lower-middle
  - "$55,000 - $59,999", "$60,000 - $64,999" - Middle
  - "$65,000 - $69,999", "$70,000 - $74,999" - Upper-middle
  - "$75,000+" - High income
- Stored as ordered factor with Low income as reference level

**Covariates:**

- **Age:** Recoded from age_recode_with_1_year_olds into numeric midpoint values (18.5 to 87 years)
- **Sex:** Recoded from original sex variable into binary factor (Male [reference], Female)
- **Cancer Stage:** Derived from combined_summary_stage_2004, coded as ordered factor (Localized [reference], Regional, Distant)
- **Year of Diagnosis:** Derived from year of diagnosis variable, entered as continuous numeric variable

## Statistical Analysis

**Primary Objective 1 - Association between Race/Ethnicity and Colon Cancer Survival:** Kaplan-Meier curves with log-rank tests were generated to visualize and compare survival by racial/ethnic groups. Restricted Mean Survival Time (RMST) was calculated for each racial/ethnic group within a 60-month window to estimate differences in average survival. Both unadjusted and adjusted RMST analyses were conducted.

**Primary Objective 2 - Association between County-Level Poverty and Colon Cancer Survival:** Kaplan-Meier curves with log-rank tests were generated to visualize and compare survival by income categories. RMST was calculated for each income category to quantify differences in survival.

**Secondary Objective 1 - Effect Modification:** A Cox proportional hazards model with race × income interaction terms was fit to assess whether county-level income modifies the race/ethnicity–mortality association. The proportional hazards (PH) assumption was tested using Schoenfeld residuals (cox.zph) for all Cox models.

**Secondary Objective 2 - Cancer Stage** -	Decompose total effects into direct effects and effects mediated through cancer stage

**Adjusted RMST Analysis:** Given the proportional hazards assumption violation, adjusted RMST using the pseudo-observation approach was conducted as the primary analysis. Due to computational constraints (memory limitations with full dataset), a stratified random sample of approximately 5,000 patients was used, maintaining proportional representation across race/ethnicity and income categories. Two models were fit:

1. **Total Effect Model:** Adjusted for confounders only (age, sex, year of diagnosis) - does NOT adjust for cancer stage (mediator)
2. **Direct Effect Model:** Adjusted for confounders plus cancer stage - estimates disparity among same-stage patients

**Software:** R version 4.4.2 with packages survival, survminer, pseudo, geepack, emmeans, ggplot2, dplyr, and kableExtra.

---

# DATA LOADING AND PREPARATION

```{r load-libraries, echo=TRUE}
library(survival)
library(survminer)
library(tidyverse)
library(dplyr)
library(janitor)
library(ggplot2)
library(gridExtra)
library(kableExtra)

# For adjusted RMST
library(pseudo)
library(geepack)
library(emmeans)

theme_set(theme_minimal() + 
          theme(panel.grid.major = element_blank(),
                panel.border = element_rect(color = "black", fill = NA),
                plot.title = element_text(hjust = 0.5, face = "bold", size = 13),
                axis.title = element_text(face = "bold", size = 11)))
```

```{r load-data, echo=TRUE}
seer <- read.csv("/Users/GAGANV/Desktop/ME/seerfinal_export.csv")
seer <- seer %>% clean_names()

cat("Dataset dimensions:", nrow(seer), "rows x", ncol(seer), "columns\n")
```

## Race/Ethnicity Recoding

```{r recode-race, echo=TRUE}
seer <- seer %>%
  mutate(
    race_ethnicity = case_when(
      race_and_origin_recode_nhw_nhb_nhaian_nhapi_hispanic == "Non-Hispanic White" ~ "NHW",
      race_and_origin_recode_nhw_nhb_nhaian_nhapi_hispanic == "Non-Hispanic Black" ~ "NHB",
      race_and_origin_recode_nhw_nhb_nhaian_nhapi_hispanic == "Hispanic (All Races)" ~ "Hispanic",
      race_and_origin_recode_nhw_nhb_nhaian_nhapi_hispanic == "Non-Hispanic Asian or Pacific Islander" ~ "API",
      race_and_origin_recode_nhw_nhb_nhaian_nhapi_hispanic == "Non-Hispanic American Indian/Alaska Native" ~ "AIAN",
      TRUE ~ "Other"
    ),
    race_ethnicity = factor(race_ethnicity, 
                            levels = c("NHW", "NHB", "Hispanic", "API", "AIAN", "Other"))
  )
```

```{r recode-race-check, results='asis', echo=FALSE}
race_check <- seer %>%
  group_by(race_ethnicity) %>%
  summarize(N = n(), Percent = round(100*n()/nrow(seer), 2), .groups = "drop")

names(race_check) <- c("Race/Ethnicity", "N", "Percent")

race_check %>%
  kable(format = "html", booktabs = TRUE, digits = 2) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover"),
    full_width = FALSE,
    position = "center"
  ) %>%
  row_spec(0, bold = TRUE, background = "#4472C4", color = "white")
```

## Income Category Recoding

```{r recode-income, echo=TRUE}
seer <- seer %>%
  mutate(
    income_cat = case_when(
      median_household_income_inflation_adj_to_2021 %in% c("< $35,000", "$35,000 - $39,999", "$40,000 - $44,999") ~ "Low income",
      median_household_income_inflation_adj_to_2021 %in% c("$45,000 - $49,999", "$50,000 - $54,999") ~ "Lower-middle",
      median_household_income_inflation_adj_to_2021 %in% c("$55,000 - $59,999", "$60,000 - $64,999") ~ "Middle",
      median_household_income_inflation_adj_to_2021 %in% c("$65,000 - $69,999", "$70,000 - $74,999") ~ "Upper-middle",
      median_household_income_inflation_adj_to_2021 == "$75,000+" ~ "High income",
      TRUE ~ NA_character_
    ),
    income_cat = factor(income_cat, 
                        levels = c("Low income", "Lower-middle", "Middle", "Upper-middle", "High income"),
                        ordered = TRUE)
  )
```

```{r recode-income-check, results='asis', echo=FALSE}
income_check <- seer %>%
  group_by(income_cat) %>%
  summarize(N = n(), Percent = round(100*n()/nrow(seer), 2), .groups = "drop")

names(income_check) <- c("Income Category", "N", "Percent")

income_check %>%
  kable(format = "html", booktabs = TRUE, digits = 2) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover"),
    full_width = FALSE,
    position = "center"
  ) %>%
  row_spec(0, bold = TRUE, background = "#4472C4", color = "white")
```

## Stage, Age, and Survival Variables

```{r recode-stage-age-survival, echo=TRUE}
seer <- seer %>%
  mutate(
    stage = factor(combined_summary_stage_2004, 
                   levels = c("Localized", "Regional", "Distant"),
                   ordered = TRUE),
    age_numeric = case_when(
      age_recode_with_1_year_olds == "18-19 years" ~ 18.5,
      age_recode_with_1_year_olds == "20-24 years" ~ 22,
      age_recode_with_1_year_olds == "25-29 years" ~ 27,
      age_recode_with_1_year_olds == "30-34 years" ~ 32,
      age_recode_with_1_year_olds == "35-39 years" ~ 37,
      age_recode_with_1_year_olds == "40-44 years" ~ 42,
      age_recode_with_1_year_olds == "45-49 years" ~ 47,
      age_recode_with_1_year_olds == "50-54 years" ~ 52,
      age_recode_with_1_year_olds == "55-59 years" ~ 57,
      age_recode_with_1_year_olds == "60-64 years" ~ 62,
      age_recode_with_1_year_olds == "65-69 years" ~ 67,
      age_recode_with_1_year_olds == "70-74 years" ~ 72,
      age_recode_with_1_year_olds == "75-79 years" ~ 77,
      age_recode_with_1_year_olds == "80-84 years" ~ 82,
      age_recode_with_1_year_olds == "85+ years" ~ 87,
      TRUE ~ NA_real_
    ),
    time = survival_months,
    event = ifelse(seer_cause_specific_death_classification == "Dead (attributable to this cancer dx)", 1, 0),
    sex_binary = factor(sex, levels = c("Male", "Female"))
  )

cat("Survival Variables:\n")
cat("  Median follow-up:", median(seer$time, na.rm = TRUE), "months\n")
cat("  Events:", sum(seer$event, na.rm = TRUE), "deaths\n")
cat("  Event rate:", round(100*mean(seer$event, na.rm = TRUE), 2), "%\n")
```

---

# DESCRIPTIVE STATISTICS

## By Race/Ethnicity

```{r descriptive-race, results='asis', echo=FALSE}
race_table <- seer %>%
  group_by(race_ethnicity) %>%
  summarize(
    N = n(),
    Deaths = sum(event),
    Event_Rate_Pct = round(100*sum(event)/n(), 1),
    Median_FU_mo = median(time, na.rm = TRUE),
    Mean_Age = round(mean(age_numeric, na.rm = TRUE), 1),
    .groups = "drop"
  ) %>%
  mutate(Percent = round(100*N/sum(N), 1)) %>%
  select(race_ethnicity, N, Percent, Deaths, Event_Rate_Pct, Median_FU_mo, Mean_Age)

names(race_table) <- c("Race/Ethnicity", "N", "%", "Deaths", "Event Rate %", "Median FU (mo)", "Mean Age")

race_table %>%
  kable(format = "html", booktabs = TRUE, align = "lrrrrrr", digits = 1) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    font_size = 11
  ) %>%
  row_spec(0, bold = TRUE, background = "#4472C4", color = "white")
```

## By Income Category

```{r descriptive-income, results='asis', echo=FALSE}
income_table <- seer %>%
  group_by(income_cat) %>%
  summarize(
    N = n(),
    Deaths = sum(event),
    Event_Rate_Pct = round(100*sum(event)/n(), 1),
    Median_FU_mo = median(time, na.rm = TRUE),
    Mean_Age = round(mean(age_numeric, na.rm = TRUE), 1),
    .groups = "drop"
  ) %>%
  mutate(Percent = round(100*N/sum(N), 1)) %>%
  select(income_cat, N, Percent, Deaths, Event_Rate_Pct, Median_FU_mo, Mean_Age)

names(income_table) <- c("Income Category", "N", "%", "Deaths", "Event Rate %", "Median FU (mo)", "Mean Age")

income_table %>%
  kable(format = "html", booktabs = TRUE, align = "lrrrrrr", digits = 1) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    font_size = 11
  ) %>%
  row_spec(0, bold = TRUE, background = "#4472C4", color = "white")
```

## By Cancer Stage

```{r descriptive-stage, results='asis', echo=FALSE}
stage_table <- seer %>%
  group_by(stage) %>%
  summarize(
    N = n(),
    Deaths = sum(event),
    Event_Rate_Pct = round(100*sum(event)/n(), 1),
    Median_FU_mo = median(time, na.rm = TRUE),
    Mean_Age = round(mean(age_numeric, na.rm = TRUE), 1),
    .groups = "drop"
  ) %>%
  mutate(Percent = round(100*N/sum(N), 1)) %>%
  select(stage, N, Percent, Deaths, Event_Rate_Pct, Median_FU_mo, Mean_Age)

names(stage_table) <- c("Stage", "N", "%", "Deaths", "Event Rate %", "Median FU (mo)", "Mean Age")

stage_table %>%
  kable(format = "html", booktabs = TRUE, align = "lrrrrrr", digits = 1) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    font_size = 11
  ) %>%
  row_spec(0, bold = TRUE, background = "#4472C4", color = "white")
```

---

# KAPLAN-MEIER CURVES

## By Race/Ethnicity

```{r km-race, echo=TRUE, results='hide'}
km_race <- survfit(Surv(time, event) ~ race_ethnicity, data = seer)
logrank_race <- survdiff(Surv(time, event) ~ race_ethnicity, data = seer)
```

```{r km-race-plot, echo=FALSE, results='markup'}
p_km_race <- ggsurvplot(km_race, data = seer,
  title = "Kaplan-Meier: Cancer-Specific Survival by Race/Ethnicity",
  xlab = "Time (months)", ylab = "Survival Probability",
  risk.table = TRUE, pval = TRUE, palette = "Dark2")
print(p_km_race)

cat("\nLog-rank Test (Race/Ethnicity) χ² =", round(logrank_race$chisq, 2), ", p < 0.0001\n")
```

## By Income Category

```{r km-income, echo=TRUE, results='hide'}
km_income <- survfit(Surv(time, event) ~ income_cat, data = seer)
logrank_income <- survdiff(Surv(time, event) ~ income_cat, data = seer)
```

```{r km-income-plot, echo=FALSE, results='markup'}
p_km_income <- ggsurvplot(km_income, data = seer,
  title = "Kaplan-Meier: Cancer-Specific Survival by Income Category",
  xlab = "Time (months)", ylab = "Survival Probability",
  risk.table = TRUE, pval = TRUE, palette = "RdYlGn")
print(p_km_income)

cat("\nLog-rank Test (Income) χ² =", round(logrank_income$chisq, 2), ", p < 0.0001\n")
```

## By Cancer Stage

```{r km-stage, echo=TRUE, results='hide'}
km_stage <- survfit(Surv(time, event) ~ stage, data = seer)
logrank_stage <- survdiff(Surv(time, event) ~ stage, data = seer)
```

```{r km-stage-plot, echo=FALSE, results='markup'}
p_km_stage <- ggsurvplot(km_stage, data = seer,
  title = "Kaplan-Meier: Cancer-Specific Survival by Stage",
  xlab = "Time (months)", ylab = "Survival Probability",
  risk.table = TRUE, pval = TRUE, palette = "Set2")
print(p_km_stage)

cat("\nLog-rank Test (Stage) χ² =", round(logrank_stage$chisq, 2), ", p < 0.0001\n")
```

---

# COX PROPORTIONAL HAZARDS MODELS

## Main Effects Model

```{r cox-model1, echo=TRUE, results='hide'}
cox_model1 <- coxph(
  Surv(time, event) ~ race_ethnicity + income_cat + age_numeric + sex_binary + 
                       stage + year_of_diagnosis,
  data = seer
)
```

```{r cox-model1-summary, echo=FALSE}
cat("**Model Formula:**\n")
cat("Surv(time, event) ~ race_ethnicity + income_cat + age_numeric + sex_binary + stage + year_of_diagnosis\n\n")
cat("**Sample Size:**\n")
cat("N = ", cox_model1$n, ", Events = ", cox_model1$nevent, "\n\n")
```

```{r cox-model1-table, results='asis', echo=FALSE}
model1_coef <- summary(cox_model1)$coefficients
model1_conf <- exp(confint(cox_model1))

model1_results <- data.frame(
  Variable = rownames(model1_coef),
  Coefficient = round(model1_coef[, 1], 4),
  HR = round(exp(model1_coef[, 1]), 4),
  HR_CI_Lower = round(model1_conf[, 1], 4),
  HR_CI_Upper = round(model1_conf[, 2], 4),
  P_value = format(model1_coef[, 5], scientific = TRUE, digits = 2)
)

names(model1_results) <- c("Variable", "Coefficient", "HR", "95% CI Lower", "95% CI Upper", "P-value")

model1_results %>%
  kable(format = "html", booktabs = TRUE, digits = 4) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "bordered"),
    full_width = FALSE,
    position = "center",
    font_size = 10
  ) %>%
  row_spec(0, bold = TRUE, background = "#4472C4", color = "white") %>%
  row_spec(which(as.numeric(model1_results$`P-value`) < 0.05), bold = TRUE, background = "#E8F4F8") %>%
  footnote(
    general = paste("Concordance =", round(summary(cox_model1)$concordance[1], 3)),
    general_title = "Model Performance:"
  )
```

## Proportional Hazards Assumption Test

```{r test-ph, echo=TRUE}
ph_test <- cox.zph(cox_model1)
```

```{r ph-plot-table, results='asis', echo=FALSE}
ph_table <- as.data.frame(ph_test$table)
ph_table$Variable <- rownames(ph_table)
ph_table <- ph_table[, c("Variable", "chisq", "df", "p")]

ph_table$chisq <- round(ph_table$chisq, 2)
ph_table$p <- format(ph_table$p, scientific = TRUE, digits = 2)

names(ph_table) <- c("Variable", "χ²", "df", "p-value")

ph_table %>%
  kable(format = "html", booktabs = TRUE) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "bordered"),
    full_width = FALSE,
    position = "center"
  ) %>%
  row_spec(0, bold = TRUE, background = "#ED7D31", color = "white") %>%
  row_spec(nrow(ph_table), bold = TRUE, background = "#FFE699")
```

```{r ph-plot, echo=TRUE, results='markup'}
plot(ph_test, main = "Schoenfeld Residuals: Proportional Hazards Assessment")
```

---

# PRIMARY ANALYSIS: RESTRICTED MEAN SURVIVAL TIME (RMST)

## Unadjusted RMST

### RMST by Race/Ethnicity (Unadjusted)

```{r rmst-race-unadj, echo=TRUE}
seer_complete <- seer %>%
  filter(!is.na(age_numeric), !is.na(income_cat), !is.na(stage), !is.na(time), !is.na(event)) %>%
  select(time, event, race_ethnicity, income_cat, age_numeric, sex_binary, stage, year_of_diagnosis)

cat("Analysis sample (complete cases):", nrow(seer_complete), "patients\n\n")

tau <- 60
rmst_race_results <- list()

for (race in levels(seer_complete$race_ethnicity)) {
  seer_race <- seer_complete %>% filter(race_ethnicity == race)
  km_fit <- survfit(Surv(time, event) ~ 1, data = seer_race)
  
  times <- c(0, km_fit$time[km_fit$time <= tau])
  surv <- c(1, km_fit$surv[km_fit$time <= tau])
  rmst <- sum(diff(times) * (surv[-length(surv)] + surv[-1]) / 2)
  
  rmst_race_results[[race]] <- list(
    RMST = rmst,
    N = nrow(seer_race),
    Events = sum(seer_race$event)
  )
}

rmst_table_unadj <- data.frame(
  Race_Ethnicity = names(rmst_race_results),
  N = sapply(rmst_race_results, "[[", "N"),
  Deaths = sapply(rmst_race_results, "[[", "Events"),
  RMST_months = round(sapply(rmst_race_results, "[[", "RMST"), 2)
)

nhw_rmst_unadj <- rmst_table_unadj$RMST_months[rmst_table_unadj$Race_Ethnicity == "NHW"]
rmst_table_unadj$Diff_vs_NHW <- round(rmst_table_unadj$RMST_months - nhw_rmst_unadj, 2)

rmst_display_unadj <- rmst_table_unadj
names(rmst_display_unadj) <- c("Race/Ethnicity", "N", "Deaths", "RMST (months)", "Difference vs NHW")
```

```{r rmst-race-unadj-table, results='asis', echo=FALSE}
rmst_display_unadj %>%
  kable(format = "html", booktabs = TRUE, align = "lrrrr", digits = 2,
        caption = "Table: Unadjusted RMST by Race/Ethnicity (Full Sample)") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "bordered"),
    full_width = FALSE,
    position = "center"
  ) %>%
  row_spec(0, bold = TRUE, background = "#4472C4", color = "white") %>%
  row_spec(1, bold = TRUE, background = "#E7E6E6") %>%
  column_spec(5, 
    color = ifelse(rmst_display_unadj$`Difference vs NHW` < 0, "darkred", "darkgreen"),
    bold = TRUE
  )
```

### RMST by Income Category (Unadjusted)

```{r rmst-income-unadj, echo=TRUE}
rmst_income_results <- list()

for (inc in levels(seer_complete$income_cat)) {
  seer_inc <- seer_complete %>% filter(income_cat == inc)
  km_fit <- survfit(Surv(time, event) ~ 1, data = seer_inc)
  
  times <- c(0, km_fit$time[km_fit$time <= tau])
  surv <- c(1, km_fit$surv[km_fit$time <= tau])
  rmst <- sum(diff(times) * (surv[-length(surv)] + surv[-1]) / 2)
  
  rmst_income_results[[inc]] <- list(
    RMST = rmst,
    N = nrow(seer_inc),
    Events = sum(seer_inc$event)
  )
}

rmst_income_table_unadj <- data.frame(
  Income_Category = names(rmst_income_results),
  N = sapply(rmst_income_results, "[[", "N"),
  Deaths = sapply(rmst_income_results, "[[", "Events"),
  RMST_months = round(sapply(rmst_income_results, "[[", "RMST"), 2)
)

low_rmst_unadj <- rmst_income_table_unadj$RMST_months[rmst_income_table_unadj$Income_Category == "Low income"]
rmst_income_table_unadj$Diff_vs_Low <- round(rmst_income_table_unadj$RMST_months - low_rmst_unadj, 2)

rmst_income_display_unadj <- rmst_income_table_unadj
names(rmst_income_display_unadj) <- c("Income Category", "N", "Deaths", "RMST (months)", "Difference vs Low")
```

```{r rmst-income-unadj-table, results='asis', echo=FALSE}
rmst_income_display_unadj %>%
  kable(format = "html", booktabs = TRUE, align = "lrrrr", digits = 2,
        caption = "Table: Unadjusted RMST by Income Category (Full Sample)") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "bordered"),
    full_width = FALSE,
    position = "center"
  ) %>%
  row_spec(0, bold = TRUE, background = "#4472C4", color = "white") %>%
  row_spec(1, bold = TRUE, background = "#E7E6E6") %>%
  column_spec(5, color = "darkgreen", bold = TRUE)
```

---

## Adjusted RMST (Pseudo-Observation Approach)

Due to the proportional hazards assumption violation (χ² = 2363.36, p < 0.0001), we use adjusted RMST as the primary analysis method. The pseudo-observation approach allows adjustment for confounders while estimating RMST.

**Computational Note:** Due to memory constraints with the full dataset (n = 181,264), a stratified random sample of approximately 5,000 patients was used. Stratification by race/ethnicity and income category ensures proportional representation is maintained.

**Key Methodological Consideration:** Cancer stage is a **mediator** (on the causal pathway: Race/Poverty → Screening → Stage → Survival), not a confounder. We present two models:

1. **Total Effect Model:** Adjusts for confounders only (age, sex, year) — estimates the full disparity
2. **Direct Effect Model:** Adjusts for confounders + stage — estimates disparity among same-stage patients

### Create Stratified Random Sample

```{r stratified-sample, echo=TRUE}
#seed for reproducibility
set.seed(12345)

# Target sample size
target_n <- 5000

# Creating stratified random sample maintaining proportions
seer_sample <- seer_complete %>%
  group_by(race_ethnicity, income_cat) %>%
  slice_sample(prop = target_n / nrow(seer_complete)) %>%
  ungroup()

# sample verification
cat("=== SAMPLING SUMMARY ===\n")
cat("Full dataset:", nrow(seer_complete), "patients\n")
cat("Stratified sample:", nrow(seer_sample), "patients\n")
cat("Events in sample:", sum(seer_sample$event), "(", 
    round(100*mean(seer_sample$event), 1), "%)\n\n")
```

```{r verify-stratification, results='asis', echo=TRUE}
# stratification maintained distributions verification
compare_dist <- data.frame(
  Race = levels(seer_complete$race_ethnicity),
  Full_N = as.numeric(table(seer_complete$race_ethnicity)),
  Full_Pct = round(100 * as.numeric(table(seer_complete$race_ethnicity)) / nrow(seer_complete), 1),
  Sample_N = as.numeric(table(seer_sample$race_ethnicity)),
  Sample_Pct = round(100 * as.numeric(table(seer_sample$race_ethnicity)) / nrow(seer_sample), 1)
)

compare_dist %>%
  kable(format = "html", booktabs = TRUE,
        caption = "Verification: Race/Ethnicity Distribution (Full vs Sample)") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#6C757D", color = "white")
```

### Calculate Pseudo-Observations

```{r pseudo-calculation, echo=TRUE}
# Centering continuous variables
seer_sample <- seer_sample %>%
  mutate(
    age_centered = age_numeric - mean(age_numeric),
    year_centered = year_of_diagnosis - 2015
  )

cat("Calculating pseudo-observations for RMST (τ =", tau, "months)...\n")

# Calculating pseudo-observations
pseudo_rmst <- pseudomean(
  time = seer_sample$time,
  event = seer_sample$event,
  tmax = tau
)

# Adding to dataset
seer_sample$pseudo_rmst <- pseudo_rmst

cat("Pseudo-observations calculated successfully!\n")
cat("Mean pseudo-RMST:", round(mean(pseudo_rmst), 2), "months\n")
```

---

### Model 1: Total Effect (Confounders Only — NO Stage Adjustment)

This model estimates the **total effect** of race/ethnicity and income on survival, including any effect operating through stage at diagnosis.

```{r glm-total-effect, echo=TRUE}
# TOTAL EFFECT MODEL
# Adjusts for: Age, Sex, Year of Diagnosis
# Does NOT adjust for: Cancer Stage (mediator)

glm_total <- glm(
  pseudo_rmst ~ race_ethnicity + income_cat + age_centered + sex_binary + year_centered,
  data = seer_sample,
  family = gaussian
)

cat("=== TOTAL EFFECT MODEL ===\n")
cat("Formula: pseudo_rmst ~ race_ethnicity + income_cat + age + sex + year\n")
cat("Adjusts for: Age, Sex, Year (confounders only)\n")
cat("Does NOT adjust for: Stage (mediator)\n\n")

summary(glm_total)
```

#### Adjusted RMST by Race/Ethnicity (Total Effect)

```{r emmeans-race-total, results='asis', echo=TRUE}
# Estimated marginal means by race/ethnicity
emm_race_total <- emmeans(glm_total, "race_ethnicity")
emm_race_total_df <- as.data.frame(emm_race_total)

# Calculatimg difference vs NHW
nhw_rmst_total <- emm_race_total_df$emmean[emm_race_total_df$race_ethnicity == "NHW"]
emm_race_total_df$diff_vs_NHW <- emm_race_total_df$emmean - nhw_rmst_total

# Display
emm_race_total_display <- emm_race_total_df %>%
  select(race_ethnicity, emmean, SE, lower.CL, upper.CL, diff_vs_NHW) %>%
  mutate(across(where(is.numeric), ~round(.x, 2)))

names(emm_race_total_display) <- c("Race/Ethnicity", "Adjusted RMST", "SE", "95% CI Lower", "95% CI Upper", "Diff vs NHW")

emm_race_total_display %>%
  kable(format = "html", booktabs = TRUE,
        caption = "Adjusted RMST by Race/Ethnicity — TOTAL EFFECT (No Stage Adjustment)") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#2E86AB", color = "white") %>%
  row_spec(1, background = "#E8E8E8") %>%
  column_spec(6, bold = TRUE, 
              color = ifelse(emm_race_total_display$`Diff vs NHW` < 0, "darkred", "darkgreen"))
```

#### Pairwise Comparisons vs NHW (Total Effect)

```{r pairs-race-total, results='asis', echo=TRUE}
# Pairwise contrasts vs NHW with confidence intervals
pairs_race_total <- contrast(emm_race_total, method = "trt.vs.ctrl", ref = 1)
pairs_race_total_ci <- confint(pairs_race_total)
pairs_race_total_df <- as.data.frame(pairs_race_total_ci)

pairs_race_total_df %>%
  mutate(across(where(is.numeric), ~round(.x, 3))) %>%
  kable(format = "html", booktabs = TRUE,
        caption = "Pairwise Differences in RMST vs NHW — TOTAL EFFECT") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#2E86AB", color = "white")
```

#### Adjusted RMST by Income Category (Total Effect)

```{r emmeans-income-total, results='asis', echo=TRUE}
# Estimated marginal means by income
emm_income_total <- emmeans(glm_total, "income_cat")
emm_income_total_df <- as.data.frame(emm_income_total)

# Calculating difference vs Low income
low_rmst_total <- emm_income_total_df$emmean[emm_income_total_df$income_cat == "Low income"]
emm_income_total_df$diff_vs_Low <- emm_income_total_df$emmean - low_rmst_total

# Display
emm_income_total_display <- emm_income_total_df %>%
  select(income_cat, emmean, SE, lower.CL, upper.CL, diff_vs_Low) %>%
  mutate(across(where(is.numeric), ~round(.x, 2)))

names(emm_income_total_display) <- c("Income Category", "Adjusted RMST", "SE", "95% CI Lower", "95% CI Upper", "Diff vs Low")

emm_income_total_display %>%
  kable(format = "html", booktabs = TRUE,
        caption = "Adjusted RMST by Income Category — TOTAL EFFECT (No Stage Adjustment)") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#28A745", color = "white") %>%
  row_spec(1, background = "#E8E8E8") %>%
  column_spec(6, bold = TRUE, color = "darkgreen")
```

---

### Model 2: Direct Effect (Including Stage Adjustment)

This model estimates the **direct effect** — the disparity that exists among patients diagnosed at the same stage.

```{r glm-direct-effect, echo=TRUE}
# DIRECT EFFECT MODEL
# Adjusts for: Age, Sex, Year, Stage

glm_direct <- glm(
  pseudo_rmst ~ race_ethnicity + income_cat + age_centered + sex_binary + year_centered + stage,
  data = seer_sample,
  family = gaussian
)

cat("=== DIRECT EFFECT MODEL ===\n")
cat("Formula: pseudo_rmst ~ race_ethnicity + income_cat + age + sex + year + stage\n")
cat("Adjusts for: Age, Sex, Year, Stage\n")
cat("Note: Adjusting for stage gives disparity among same-stage patients\n\n")

summary(glm_direct)
```

#### Adjusted RMST by Race/Ethnicity (Direct Effect)

```{r emmeans-race-direct, results='asis', echo=TRUE}
# Estimated marginal means by race/ethnicity (direct effect)
emm_race_direct <- emmeans(glm_direct, "race_ethnicity")
emm_race_direct_df <- as.data.frame(emm_race_direct)

# Calculating difference vs NHW
nhw_rmst_direct <- emm_race_direct_df$emmean[emm_race_direct_df$race_ethnicity == "NHW"]
emm_race_direct_df$diff_vs_NHW <- emm_race_direct_df$emmean - nhw_rmst_direct

# Display
emm_race_direct_display <- emm_race_direct_df %>%
  select(race_ethnicity, emmean, SE, lower.CL, upper.CL, diff_vs_NHW) %>%
  mutate(across(where(is.numeric), ~round(.x, 2)))

names(emm_race_direct_display) <- c("Race/Ethnicity", "Adjusted RMST", "SE", "95% CI Lower", "95% CI Upper", "Diff vs NHW")

emm_race_direct_display %>%
  kable(format = "html", booktabs = TRUE,
        caption = "Adjusted RMST by Race/Ethnicity — DIRECT EFFECT (With Stage Adjustment)") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#DC3545", color = "white") %>%
  row_spec(1, background = "#E8E8E8") %>%
  column_spec(6, bold = TRUE, 
              color = ifelse(emm_race_direct_display$`Diff vs NHW` < 0, "darkred", "darkgreen"))
```

#### Adjusted RMST by Income Category (Direct Effect)

```{r emmeans-income-direct, results='asis', echo=TRUE}
# Estimated marginal means by income (direct effect)
emm_income_direct <- emmeans(glm_direct, "income_cat")
emm_income_direct_df <- as.data.frame(emm_income_direct)

# Calculating difference vs Low income
low_rmst_direct <- emm_income_direct_df$emmean[emm_income_direct_df$income_cat == "Low income"]
emm_income_direct_df$diff_vs_Low <- emm_income_direct_df$emmean - low_rmst_direct

# Display
emm_income_direct_display <- emm_income_direct_df %>%
  select(income_cat, emmean, SE, lower.CL, upper.CL, diff_vs_Low) %>%
  mutate(across(where(is.numeric), ~round(.x, 2)))

names(emm_income_direct_display) <- c("Income Category", "Adjusted RMST", "SE", "95% CI Lower", "95% CI Upper", "Diff vs Low")

emm_income_direct_display %>%
  kable(format = "html", booktabs = TRUE,
        caption = "Adjusted RMST by Income Category — DIRECT EFFECT (With Stage Adjustment)") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#FFC107", color = "black") %>%
  row_spec(1, background = "#E8E8E8") %>%
  column_spec(6, bold = TRUE, color = "darkgreen")
```

---

### Comparison: Total Effect vs Direct Effect

```{r comparison-race, results='asis', echo=TRUE}
# Compare Total vs Direct effects for Race/Ethnicity
comparison_race <- data.frame(
  Race_Ethnicity = levels(seer_sample$race_ethnicity),
  Unadj_RMST = rmst_table_unadj$RMST_months,
  Unadj_Diff = rmst_table_unadj$Diff_vs_NHW,
  Total_RMST = round(emm_race_total_df$emmean, 2),
  Total_Diff = round(emm_race_total_df$diff_vs_NHW, 2),
  Direct_RMST = round(emm_race_direct_df$emmean, 2),
  Direct_Diff = round(emm_race_direct_df$diff_vs_NHW, 2)
)

# Calculating mediated effect (through stage)
comparison_race$Mediated <- round(comparison_race$Total_Diff - comparison_race$Direct_Diff, 2)

comparison_race %>%
  rename(
    `Race/Ethnicity` = Race_Ethnicity,
    `Unadj RMST` = Unadj_RMST,
    `Unadj Diff` = Unadj_Diff,
    `Total RMST` = Total_RMST,
    `Total Diff` = Total_Diff,
    `Direct RMST` = Direct_RMST,
    `Direct Diff` = Direct_Diff,
    `Mediated by Stage` = Mediated
  ) %>%
  kable(format = "html", booktabs = TRUE, digits = 2,
        caption = "Comparison: Unadjusted vs Total Effect vs Direct Effect — By Race/Ethnicity") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#6C757D", color = "white") %>%
  column_spec(3, color = ifelse(comparison_race$Unadj_Diff < 0, "darkred", "darkgreen")) %>%
  column_spec(5, bold = TRUE, color = ifelse(comparison_race$Total_Diff < 0, "darkred", "darkgreen")) %>%
  column_spec(7, color = ifelse(comparison_race$Direct_Diff < 0, "darkred", "darkgreen")) %>%
  column_spec(8, bold = TRUE, color = "purple") %>%
  footnote(
    general = "Unadjusted = crude KM-based. Total = adjusted for confounders only. Direct = also adjusted for stage. Mediated = Total − Direct (portion through stage).",
    general_title = "Notes: "
  )
```

```{r comparison-income, results='asis', echo=TRUE}
# Comparing  Income
comparison_income <- data.frame(
  Income_Category = levels(seer_sample$income_cat),
  Unadj_RMST = rmst_income_table_unadj$RMST_months,
  Unadj_Diff = rmst_income_table_unadj$Diff_vs_Low,
  Total_RMST = round(emm_income_total_df$emmean, 2),
  Total_Diff = round(emm_income_total_df$diff_vs_Low, 2),
  Direct_RMST = round(emm_income_direct_df$emmean, 2),
  Direct_Diff = round(emm_income_direct_df$diff_vs_Low, 2)
)

comparison_income$Mediated <- round(comparison_income$Total_Diff - comparison_income$Direct_Diff, 2)

comparison_income %>%
  rename(
    `Income Category` = Income_Category,
    `Unadj RMST` = Unadj_RMST,
    `Unadj Diff` = Unadj_Diff,
    `Total RMST` = Total_RMST,
    `Total Diff` = Total_Diff,
    `Direct RMST` = Direct_RMST,
    `Direct Diff` = Direct_Diff,
    `Mediated by Stage` = Mediated
  ) %>%
  kable(format = "html", booktabs = TRUE, digits = 2,
        caption = "Comparison: Unadjusted vs Total Effect vs Direct Effect — By Income Category") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#6C757D", color = "white") %>%
  column_spec(5, bold = TRUE, color = "darkgreen") %>%
  column_spec(8, bold = TRUE, color = "purple")
```

---

# SECONDARY OBJECTIVE: EFFECT MODIFICATION BY INCOME

## Interaction Model: Race × Income

```{r cox-model2, echo=TRUE, results='hide'}
cox_model2 <- coxph(
  Surv(time, event) ~ race_ethnicity * income_cat + age_numeric + sex_binary + 
                       stage + year_of_diagnosis,
  data = seer
)
```

```{r cox-model2-lrt, results='asis', echo=FALSE}
lrt <- anova(cox_model1, cox_model2)

chisq_val <- lrt$Chisq[2]
pval <- lrt$`Pr(>|Chi|)`[2]

lrt_table <- data.frame(
  Model = c("Main Effects", "Race × Income"),
  Parameters = c(length(coef(cox_model1)), length(coef(cox_model2))),
  Chisq = c(NA, round(chisq_val, 2)),
  P_value = c(NA, format.pval(pval, digits = 3))
)

names(lrt_table) <- c("Model", "Parameters", "χ²", "P-value")

lrt_table %>%
  kable(format = "html", booktabs = TRUE, align = "lrrr") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover"),
    full_width = FALSE,
    position = "center"
  ) %>%
  row_spec(0, bold = TRUE, background = "#4472C4", color = "white") %>%
  footnote(general = paste("LRT χ² =", round(chisq_val, 2), "on", 
                           length(coef(cox_model2)) - length(coef(cox_model1)), 
                           "df; p =", format.pval(pval, digits = 3)))
```

## Interaction Coefficients

```{r cox-model2-coefficients, results='asis', echo=FALSE}
model2_coef <- summary(cox_model2)$coefficients
model2_conf <- exp(confint(cox_model2))

interaction_indices <- grep(":", rownames(model2_coef))
interaction_coef <- model2_coef[interaction_indices, ]
interaction_conf <- model2_conf[interaction_indices, ]

interaction_results <- data.frame(
  Term = rownames(interaction_coef),
  Coefficient = round(interaction_coef[, 1], 4),
  HR = round(exp(interaction_coef[, 1]), 4),
  HR_CI_Lower = round(interaction_conf[, 1], 4),
  HR_CI_Upper = round(interaction_conf[, 2], 4),
  P_value = format(interaction_coef[, 5], scientific = TRUE, digits = 2)
)

names(interaction_results) <- c("Interaction Term", "Coefficient", "HR", "95% CI Lower", "95% CI Upper", "P-value")

interaction_results %>%
  kable(format = "html", booktabs = TRUE, digits = 4) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "bordered"),
    full_width = FALSE,
    position = "center",
    font_size = 9
  ) %>%
  row_spec(0, bold = TRUE, background = "#4472C4", color = "white") %>%
  row_spec(which(as.numeric(interaction_results$`P-value`) < 0.05), bold = TRUE, background = "#E8F4F8") %>%
  footnote(general = "Interaction terms represent how the effect of race/ethnicity varies by income category")
```

---

# RESULTS SUMMARY

```{r results-summary, echo=FALSE, results='markup'}
cat("=======================================================================\n")
cat("                        RESULTS SUMMARY                                \n")
cat("=======================================================================\n\n")

cat("SAMPLE CHARACTERISTICS\n")
cat("----------------------\n")
cat("Total sample: N =", nrow(seer_complete), "colon cancer patients (2010-2020)\n")
cat("Events:", sum(seer_complete$event), "cancer-specific deaths (", 
    round(100*mean(seer_complete$event), 1), "%)\n", sep = "")
cat("Adjusted RMST analysis: n =", nrow(seer_sample), "(stratified random sample)\n\n")

cat("PRIMARY OBJECTIVE 1: RACE/ETHNICITY AND SURVIVAL\n")
cat("------------------------------------------------\n")
cat("NHB vs NHW (Unadjusted):", rmst_table_unadj$Diff_vs_NHW[rmst_table_unadj$Race_Ethnicity == "NHB"], "months\n")
cat("NHB vs NHW (Total Effect):", round(emm_race_total_df$diff_vs_NHW[emm_race_total_df$race_ethnicity == "NHB"], 2), "months\n")
cat("NHB vs NHW (Direct Effect):", round(emm_race_direct_df$diff_vs_NHW[emm_race_direct_df$race_ethnicity == "NHB"], 2), "months\n\n")

cat("PRIMARY OBJECTIVE 2: INCOME AND SURVIVAL\n")
cat("----------------------------------------\n")
cat("High vs Low Income (Unadjusted): +", rmst_income_table_unadj$Diff_vs_Low[rmst_income_table_unadj$Income_Category == "High income"], "months\n", sep = "")
cat("High vs Low Income (Total Effect): +", round(emm_income_total_df$diff_vs_Low[emm_income_total_df$income_cat == "High income"], 2), "months\n\n", sep = "")

cat("SECONDARY OBJECTIVE: EFFECT MODIFICATION\n")
cat("----------------------------------------\n")
cat("Race × Income interaction: χ² =", round(chisq_val, 2), ", p =", format.pval(pval, digits = 3), "\n")
cat("Interpretation: Statistically significant but modest practical magnitude\n")
cat("=======================================================================\n")
```

---

# DISCUSSION

## Key Findings

This analysis of SEER data documents significant and clinically meaningful health disparities in colon cancer-specific survival by both race/ethnicity and county-level income.

**Methodological Innovation:** This analysis employed adjusted RMST using the pseudo-observation approach, which appropriately addresses the proportional hazards assumption violation while allowing adjustment for confounders. We presented both:

1. **Total Effect:** The full disparity, adjusting for confounders only (age, sex, year)
2. **Direct Effect:** The disparity among same-stage patients (also adjusting for stage)

The difference between these estimates reflects the portion of the disparity **mediated through cancer stage** (i.e., due to later-stage diagnosis among disadvantaged groups).

## Interpretation of Mediation

The "Mediated by Stage" column in the comparison tables shows how much of the disparity operates through differences in stage at diagnosis:

- **Positive mediation:** Part of the disadvantage is due to later-stage diagnosis (screening disparities)
- **Remaining direct effect:** Disparity that persists even among same-stage patients (treatment quality, adherence, biology)

## Limitations

1. **Proportional Hazards Violation:** Cox model results should be interpreted with caution
2. **Stratified Sampling:** Adjusted RMST used n ≈ 5,000 sample due to computational constraints
3. **County-Level Income:** Subject to ecological fallacy
4. **Missing Treatment Data:** Cannot assess treatment-related mechanisms
5. **Stage as Mediator:** Adjusting for stage estimates direct effect only

---

# CONCLUSION

This population-based cohort study documents substantial disparities in colon cancer survival by race/ethnicity and county-level income. Using adjusted RMST (pseudo-observation approach), we demonstrate that:

1. **Non-Hispanic Black patients** experience significant survival disadvantages compared to Non-Hispanic White patients
2. A clear **socioeconomic gradient** exists, with high-income patients experiencing better outcomes
3. Part of the racial disparity is **mediated through later-stage diagnosis**, but a substantial **direct effect** remains
4. Race/ethnicity and income effects operate **largely independently**

These findings underscore the need for multilevel interventions addressing both systemic racism and economic barriers to achieve health equity in cancer outcomes.

---

# SESSION INFORMATION

```{r session-info, echo=TRUE}
sessionInfo()
```

---

**Analysis Date:** `r format(Sys.Date(), "%B %d, %Y")`
**Study:** SEER Colon Cancer Survival Analysis  
**Author:** Gagan Vijay  
**Supervisory Faculty:** Dr. Kim, Washington University in St. Louis
